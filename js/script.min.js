'use strict';const container=document.querySelector('.container');const cells=document.querySelectorAll('.container>.container__cell');const combinations=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];let name1='Игрок1',name2='Игрок2',stateFields=[],possibleFields=[],history=[],temp_history=[],level=1,flagGame=false,variant=1,step=0,currentGamer='x',numberGame=-1;startGame();function startGame(){addClick('.form__optionType',toggleType);addClick('.form__send',sendData)}function addClick(selector,act){document.querySelector(selector).addEventListener('click',act)}function removeClick(selector,act){if(document.querySelector('selector')){document.querySelector(selector).removeEventListener('click',act)}}function toggleType(){let variant=document.querySelector('.form__option [name="variant"]:checked');if(variant.value==='1'){document.querySelectorAll('.form__player .form__title')[0].innerText='Игрок:';document.querySelectorAll('.form__player')[1].classList.add('form__player_none');document.querySelector('.form__optionLevel').classList.remove('form__optionLevel_none')}else if(variant.value==='2'){document.querySelectorAll('.form__player .form__title')[0].innerText='Игрок 1:';document.querySelectorAll('.form__player')[1].classList.remove('form__player_none');document.querySelector('.form__optionLevel').classList.add('form__optionLevel_none')}}function sendData(event){event.preventDefault();name1=document.querySelector('.form__player [name="player1"]').value||'Игрок1',variant=Number(document.querySelector('.form__option [name="variant"]:checked').value),level=Number(document.querySelector('.form__option [name="level"]:checked').value);if(variant===1){name2='Компьютер'}else{name2=document.querySelector('.form__player [name="player2"]').value||'Игрок2'}document.querySelectorAll('.score .score__title')[0].innerHTML=name1;document.querySelectorAll('.score .score__title')[0].setAttribute('title',name1);document.querySelectorAll('.score .score__title')[1].innerHTML=name2;document.querySelectorAll('.score .score__title')[1].setAttribute('title',name2);initialization()}function initialization(){Default();if(variant===1&&numberGame%2===1){computer()}for(let i=0;i<stateFields.length;i++){cells[i].addEventListener('click',clickOnCell)}}function Default(){flagGame=true;document.querySelector('.wrapper').style.display='none';document.querySelector('.game').style.display='block';if(document.querySelector('nav')){deleteNav()}deleteHistory();stateFields=[0,0,0,0,0,0,0,0,0];possibleFields=[0,1,2,3,4,5,6,7,8];step=0;numberGame++;cells.forEach(cell=>{cell.classList.remove('win_row');cell.innerHTML=''});currentGamer='x';switchStep()}function switchStep(){if(numberGame%2===0){if(step%2===0){document.querySelector('.score__player1 .score__title').classList.add('score__title_active');document.querySelector('.score__player2 .score__title').classList.remove('score__title_active')}else{document.querySelector('.score__player1 .score__title').classList.remove('score__title_active');document.querySelector('.score__player2 .score__title').classList.add('score__title_active')}}else{if(step%2===1){document.querySelector('.score__player1 .score__title').classList.add('score__title_active');document.querySelector('.score__player2 .score__title').classList.remove('score__title_active')}else{document.querySelector('.score__player1 .score__title').classList.remove('score__title_active');document.querySelector('.score__player2 .score__title').classList.add('score__title_active')}}}function clickOnCell(event){let position=getPosition(event.target);changeState(position);if(variant===1){computer()}}function getPosition(element){let position=0;while(element.previousSibling){element=element.previousSibling;if(element.nodeType===1){position++}}return position}function randomPosition(array){return Math.floor(Math.random()*(array.length))}function computer(){if(flagGame===false){return}if(level===1){easy()}else if(level===2){normal()}}function easy(){let position=randomPosition(possibleFields);changeState(possibleFields[position])}function normal(){if(step===0||step===1){initialStrategy(step);return}let x=(currentGamer==='x')?1:2;if(selection(x)===false){x=(x===1)?2:1;if(selection(x)===false){initialStrategy(step)}}}function initialStrategy(step=-1){let safeField=[0,2,6,8];if(step===0||step===1){safeField=[4]}else if(step===2||step===3){safeField=[1,3,5,7]}let counter=0;while(true){let position=randomPosition(safeField);if(stateFields[safeField[position]]===0){changeState(safeField[position]);break}if(step===0||step===1){safeField=[0,2,6,8]}if(counter>10){easy();break}counter++}}function selection(x){for(let i=0;i<stateFields.length-1;i++){if(stateFields[i]===x){for(let j=i+1;j<stateFields.length;j++){if(stateFields[j]===x){let position=checkWinnigField(i,j);if(position!==false){changeState(position);return true}}}}}return false}function checkWinnigField(position1,position2){for(let i=0;i<combinations.length;i++){if(combinations[i][0]===position1&&combinations[i][1]===position2&&stateFields[combinations[i][2]]===0){return combinations[i][2]}if(combinations[i][0]===position1&&combinations[i][2]===position2&&stateFields[combinations[i][1]]===0){return combinations[i][1]}if(combinations[i][1]===position1&&combinations[i][2]===position2&&stateFields[combinations[i][0]]===0){return combinations[i][0]}}return false}function changeState(position){cells[position].innerHTML=currentGamer;possibleFields.splice(possibleFields.indexOf(position),1);cells[position].removeEventListener('click',clickOnCell);let name=name1;if(numberGame%2===0){name=(step%2===0)?name1:name2}else{name=(step%2===0)?name2:name1}temp_history.push({name:name,position:position,symbol:currentGamer});if(currentGamer==='x'){currentGamer='0';stateFields[position]=1}else{currentGamer='x';stateFields[position]=2}checkWin()}function checkWin(){for(let i=0;i<combinations.length;i++){if(cells[combinations[i][0]].innerHTML==='x'&&cells[combinations[i][1]].innerHTML==='x'&&cells[combinations[i][2]].innerHTML==='x'){console.log('победили крестики');stopGame(1,combinations[i]);return}else if(cells[combinations[i][0]].innerHTML==='0'&&cells[combinations[i][1]].innerHTML==='0'&&cells[combinations[i][2]].innerHTML==='0'){console.log('победили нолики');stopGame(2,combinations[i]);return}}step++;if(step>=stateFields.length){stopGame(3);console.log('Ничья');return}switchStep()}function stopGame(result,comb=[]){flagGame=false;for(let i=0;i<comb.length;i++){cells[comb[i]].classList.add('win_row')}for(let i=0;i<stateFields.length;i++){cells[i].removeEventListener('click',clickOnCell)}let title='';let lastStep=document.querySelector('.score .score__title_active');if(result===1||result===2){let score=lastStep.parentElement.querySelector('.score__number');score.innerHTML=Number(score.innerHTML)+1;if(numberGame%2===0){title=(step%2===0)?`${name1} выиграл`:`${name2} выиграл`}else{title=(step%2===0)?`${name2} выиграл`:`${name1} выиграл`}}else{lastStep.classList.remove('score__title_active');title='Ничья'}temp_history.push({title:title,combination:comb});history.push(temp_history);temp_history=[];renderNav()}function renderNav(){let nav=document.createElement('nav');nav.className='nav';nav.innerHTML=`<button class="button nav__button"id="continueGame">Играть еще</button><button class="button nav__button"id="resetResult">Сбросить результаты</button><button class="button nav__button"id="backSetting">Вернуться к настройкам</button><button class="button nav__button"id="showHistory"data-act="show">Показать историю</button>`;document.querySelector('.game').append(nav);addClick('#continueGame',continueGame);addClick('#resetResult',resetResult);addClick('#backSetting',backSetting);addClick('#showHistory',historyController)}function deleteNav(){removeClick('#continueGame',continueGame);removeClick('#resetResult',resetResult);removeClick('#backSetting',backSetting);removeClick('#showHistory',historyController);document.querySelector('nav').remove()}function continueGame(){initialization()}function resetResult(){history=[];currentGamer='x';numberGame=-1;deleteHistory();removeClick('#showHistory',historyController);document.querySelector('#showHistory').remove();removeClick('#resetResult',resetResult);this.remove();let scores=document.querySelectorAll('.score .score__number');scores.forEach(score=>score.innerHTML='0')}function backSetting(){document.querySelector('.game').style.display='none';document.querySelector('.wrapper').style.display='block';document.querySelector('.wrapper .form__send').innerHTML='Изменить параметры';document.querySelector('.wrapper .form__back').style.display='block';addClick('.wrapper .form__back',backGame)}function backGame(){event.preventDefault();document.querySelector('.game').style.display='block';document.querySelector('.wrapper').style.display='none';document.querySelector('.wrapper .form__back').style.display='none';removeClick('.wrapper .form__back',backGame)}function historyController(){let dataAct=this.getAttribute('data-act');if(dataAct==='show'){this.innerHTML='Скрыть историю';this.setAttribute('data-act','hide');showHistory()}else{this.innerHTML='Показать историю';this.setAttribute('data-act','show');document.querySelector('.history').style.display='none'}}function deleteHistory(){if(document.querySelector('.history')){removeClick('.history',clickController);document.querySelector('.history').remove()}}function showHistory(){if(!document.querySelector('.history')){createHistory()}document.querySelector('.history').style.display='block';addClick('.history',clickController)}function createHistory(){let historyHtml=document.createElement('div');historyHtml.className='history';let historyItems='';for(let i=0;i<history.length;i++){historyItems+=`<div class="history-item"data-id="${i}"><div class="history-item__link"><div class="history-item__title"title="${history[i][history[i].length - 1].title}">${history[i][history[i].length-1].title}</div><div class="history-item__show"data-act="show">Показать детали</div></div></div>`}historyHtml.innerHTML=historyItems;document.querySelector('.game').append(historyHtml)}function clickController(event){if(event.target.classList.contains('history-item__show')){contollerDetails(event)}else if(event.target.classList.contains('history-nav__step')){DetailsStep(event.target)}}function contollerDetails(event){let itemShow=event.target;if(itemShow.getAttribute('data-act')==='show'){itemShow.innerHTML='Скрыть детали';itemShow.setAttribute('data-act','hide');showDetails(itemShow.closest('.history-item'))}else{itemShow.innerHTML='Показать детали';itemShow.setAttribute('data-act','show');itemShow.closest('.history-item').querySelector('.history-item__details').style.display='none'}}function showDetails(historyItem){let dataId=historyItem.getAttribute('data-id');let details=historyItem.querySelector('.history-item__details');if(!details){renderDetail(historyItem,dataId);details=historyItem.querySelector('.history-item__details')}showStep(historyItem,dataId);details.style.display='block'}function DetailsStep(element){let numberStep=element.getAttribute('data-step');let historyItem=element.closest('.history-item');let dataId=historyItem.getAttribute('data-id');let historyCells=historyItem.querySelectorAll('.history-desk__cell');historyCells.forEach(cell=>{cell.innerHTML='';cell.classList.remove('win_row')});showStep(historyItem,dataId,numberStep)}function showStep(element,dataId,numberStep=0){numberStep=Number(numberStep);let historyCells=element.querySelectorAll('.history-desk__cell');for(let i=0;i<numberStep+1;i++){let historyElement=history[dataId][i];historyCells[historyElement.position].innerHTML=history[dataId][i].symbol}if(numberStep===history[dataId].length-2){let combination=history[dataId][history[dataId].length-1].combination;for(let i=0;i<combination.length;i++){historyCells[combination[i]].classList.add('win_row')}}}function renderDetail(element,id){let detail=document.createElement('div');detail.className='history-item__details';let navContainer='';for(let i=0;i<history[id].length-1;i++){navContainer+=`<span class="history-nav__title"title="${history[id][i].name}">${history[id][i].name}:</span><button class="history-nav__step"data-step="${i}">Ход${i+1}</button>`}detail.innerHTML=`<div class="history-nav">${navContainer}</div><div class="history-desk"><div class="history-desk__container"><div class="history-desk__cell"></div><div class="history-desk__cell"></div><div class="history-desk__cell"></div><div class="history-desk__cell"></div><div class="history-desk__cell"></div><div class="history-desk__cell"></div><div class="history-desk__cell"></div><div class="history-desk__cell"></div><div class="history-desk__cell"></div></div></div>`;element.append(detail)}